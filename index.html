<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="UTF-8">
    <title>Micro:bit BLELogger Console</title>
</head>

<body>
    <div class="box">
        <div class="row header">
                <button id="connect" class="button">Connect</button>
        </div>
        <div class="row header">
                <button id="disconnect" class="button">Disconnect All</button>
        </div>
        <div class="row header">
                <button id="clear" class="button">Clear Console</button>
        </div>
        <div class="row header">
            <button id="download" class="button">Download CSV (last connected & while connected)</button>
        </div>

        <div id="console" class="row content" style="overflow:auto;border:4px solid black;padding:2%">
            Waiting for connection.
        </div>                            
    </div>
</body>

<!--  Include the DAP support library and WebUSB support -->
<script src="ubitwebblelog.js"></script>

<script>

    // Append a line to the console frame
    function consolePrintln(message) {
        var con = document.getElementById("console")
        con.innerHTML += "<br/>"+message
        con.scrollTop = con.scrollHeight
    }

    let uBM = new uBitManager()
    let d = null
    // Make the "go" button open the request devices box
    uBM.addEventListener("connected", (e)=> {
        // console.log("New Device connected")
        // console.dir(e.detail)
        consolePrintln(`Connected to: ${e.detail.name}`)
        d = e.detail
    })
    uBM.addEventListener("disconnected", (e)=> {
        // console.log("Device disconnected")
        // console.dir(e.detail)
        consolePrintln(`Disconnected from: ${e.detail.name}`)
    })

    uBM.addEventListener("progress", (e)=> {
        // console.log(`Progress ${e.detail.device.name}: ${e.detail.progress}%`)
        consolePrintln(`Progress ${e.detail.device.name}: ${e.detail.progress}%`)
    })

    uBM.addEventListener("log usage", (e)=> {
        // console.log(`Log Usage ${e.detail.device.name}: ${e.detail.percent}%`)
        consolePrintln(`Log Usage ${e.detail.device.name}: ${e.detail.percent}%`)
    })


    document.getElementById("connect").addEventListener("click", () => uBM.connect())

    document.getElementById("disconnect").addEventListener("click", () => {
        for(let [id, device] of uBM.getDevices()) {
            device.disconnect()
        }
    })

    document.getElementById("download").addEventListener("click", () => d && d.download("data.csv"))

</script>

</html>
